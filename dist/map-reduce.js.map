{"version":3,"sources":["map-reduce.js"],"names":["mapReduce","chain","opts","cb","bucket","options","putCb","opt","fields","allFields","console","log","Object","assign","doMapReduce","logger","fun","logging","_log","args","newField","newValue","value","filter","filters","ignoreFields","iterator","validField","processWhile","updateWhen","updateBucket","deleteFromBucket","done","ctx","oldProps","newProps","filteredFields","visited","updated","processedFields","defaultProcessWhile","field","val","reVisit","decision","defaultValidField","valid","length","indexOf","invalid","defaultUpdateWhen","processedAll","visitedAll","every","f","defaultDeleteFromBucket","deleteKeys","keys","dkey","get","put","defaultUpdateBucket","defaultDone","Error","ensureFun","v","newFieldFun","newValueFun","oldValueFun","map","newKey","oldValue","doFilter","reduce","filtered","doReduce","doUpdate"],"mappings":"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","file":"map-reduce.js","sourcesContent":["import './live'\nimport './value'\nimport './async'\nimport './fields'\n\nimport Gun from 'gun/gun'\n\nGun.chain.mapReduce = function (opts, cb) {\n  mapReduce(this, opts, cb)\n}\n\nexport function mapReduce(bucket, options = {}, cb, putCb, opt) {\n\n  bucket.fields((allFields) => {\n    console.log('allFields', allFields)\n    options = Object.assign(options, {\n      allFields\n    })\n    doMapReduce(bucket, options, cb, putCb, opt)\n  })\n}\n\nfunction logger(fun, logging) {\n  return function _log(...args) {\n    if (logging)\n      console.log(fun, ...args)\n  }\n}\n\nfunction doMapReduce(bucket, {\n  newField,\n  newValue,\n  value,\n  filter,\n  filters,\n  fields = [],\n  ignoreFields = [],\n  allFields,\n  iterator = 'val',\n  validField,\n  processWhile,\n  updateWhen,\n  updateBucket,\n  deleteFromBucket,\n  done,\n  logging = false\n}, cb, putCb, opt) {\n\n  let ctx = {\n    oldProps: {},\n    newProps: {},\n    filteredFields: {},\n    visited: {},\n    updated: false,\n    processedFields: 0,\n    allFields,\n    fields,\n    ignoreFields\n  }\n\n  const log = logger(iterator, logging)\n\n  log('ctx', ctx)\n\n  function defaultProcessWhile({\n    field,\n    val,\n    ctx\n  }) {\n    let reVisit = ctx.visited[field]\n    let decision = !reVisit\n    log('processWhile', reVisit, decision)\n    return decision\n  }\n\n  function defaultValidField(field, ctx) {\n    let {\n      fields,\n      ignoreFields\n    } = ctx\n    let valid = fields.length === 0 || fields.length > 0 && fields.indexOf(field) >= 0\n    let invalid = ignoreFields.length > 0 && ignoreFields.indexOf(field) >= 0\n    return valid && !invalid\n  }\n\n  function defaultUpdateWhen({\n    field,\n    val,\n    ctx\n  }) {\n    let processedAll = (ctx.processedFields >= ctx.allFields.length)\n    let visitedAll = ctx.allFields.every(f => ctx.visited[f])\n    let decision = visitedAll && processedAll\n    log('updateWhen', visitedAll, processedAll, decision)\n    return decision\n  }\n\n  function defaultDeleteFromBucket(bucket, ctx) {\n    let deleteKeys = Object.keys(ctx.filteredFields)\n    if (deleteKeys.length > 0) {\n      log('DELETE', deleteKeys)\n      for (let dkey of deleteKeys) {\n        bucket.get(dkey).put(null, putCb, opt)\n      }\n    }\n  }\n\n  function defaultUpdateBucket(bucket, ctx) {\n    log('put', ctx.oldProps)\n    bucket.put(ctx.oldProps, putCb, opt)\n    log('put', ctx.newProps)\n    bucket.put(ctx.newProps, putCb, opt)\n  }\n\n  function defaultDone(bucket, cb) {\n    log('DONE')\n    if (cb) {\n      cb(bucket)\n    } else {\n      throw Error('Missing callback', cb)\n    }\n  }\n\n  validField = validField || defaultValidField\n  processWhile = processWhile || defaultProcessWhile\n  updateWhen = updateWhen || defaultUpdateWhen\n  updateBucket = updateBucket || defaultUpdateBucket\n  deleteFromBucket = deleteFromBucket || defaultDeleteFromBucket\n  done = done || defaultDone\n\n\n  function ensureFun(fun) {\n    if (fun && typeof fun !== 'function') {\n      return (v) => fun\n    } else {\n      return fun\n    }\n  }\n\n  let newFieldFun = ensureFun(newField)\n  let newValueFun = ensureFun(newValue)\n  let oldValueFun = ensureFun(value)\n\n  log(allFields)\n\n  // processWhile = processWhile.bind(this)\n  // updateWhen = updateWhen.bind(this)\n\n  bucket.map()[iterator](function (val, field) {\n    log('iterate', {\n      field,\n      val\n    })\n    if (!validField(field, ctx)) return\n\n    let newKey = newFieldFun ? newFieldFun(field, val) : field\n    let newValue = newValueFun ? newValueFun(val, field) : val\n    let oldValue = oldValueFun ? oldValueFun(val, field) : val\n    let doFilter = false\n\n    if (filters) {\n      log('process filters', filters.length)\n      doFilter = filters.reduce((filtered, filter) => {\n        return !filtered ? filter(field, val) : filtered\n      }, false)\n    }\n\n    if (filter && filter(field, val)) {\n      doFilter = true\n    }\n\n    log({\n      newKey,\n      newValue,\n      oldValue,\n      doFilter\n    })\n\n    let doReduce = processWhile({\n      field,\n      val,\n      ctx\n    })\n    log('doReduce', doReduce)\n\n    if (doReduce) {\n      log('reduce', {\n        field,\n        val,\n        processedFields: ctx.processedFields\n      })\n      if (doFilter) {\n        ctx.filteredFields[field] = true\n      } else {\n        ctx.oldProps[field] = oldValue\n        ctx.newProps[newKey] = newValue\n      }\n      ctx.visited[field] = true\n      ctx.visited[newKey] = true\n      ctx.processedFields++\n    }\n    let doUpdate = updateWhen({\n      field,\n      val,\n      ctx\n    })\n    log('doUpdate', doUpdate, ctx.processedFields)\n    if (doUpdate) {\n      // on stopCondition\n      if (!ctx.updated) {\n        log('UPDATE BUCKET')\n        ctx.updated = true\n        updateBucket(bucket, ctx)\n        deleteFromBucket(bucket, ctx)\n        done(bucket, cb)\n      } else {\n        log('ignore update')\n      }\n    }\n  })\n}"]}